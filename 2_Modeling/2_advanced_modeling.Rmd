---
title: "Avanced structural equation modeling"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
header-includes:
   - \usepackage{svg}
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# To do
* non-linear relationships
* interactions
* multigroup fitting


# Load libraries
```{r}
library("lavaan")
```


# Load data
Load the data and scale them to a mean of zero and a standard deviation of one.

```{r}
rm(list = ls())
seabloom <- read.table("~/Swiss_SEM/2_Modeling/Data_preparation/seabloom-2020-ele-dryad-data/cdr-e001-e002-output-data.csv",
                       sep = ",", header = TRUE)

seabloom[, c(4, 7, 13:15)] <- apply(seabloom[, c(4, 7, 13:15)],  2, scale)
```


# Latent and composite variables
- difference between latent and composite variable
- SEM with latent variable(s)
- SEM with composite variable(s)

![](Figures/LatentCompositeSEM.svg){width=70%}

## Latent variable "diversity"

```{r}
sem2 <-"
# Latent variable definition
diversity =~ rich + even

mass.above ~ nadd + diversity + disk
diversity ~ nadd
"

fit.sem2 <- sem(sem2, data = seabloom)
summary(fit.sem2)
```


## Composite variable "land use intensity"

<!-- ```{r} -->
<!-- compositeModel <- ' -->
<!--     #1) define the composite, scale to logN -->
<!--     Nitrogen ~ 1*logN + logNcen2 #loading on the significant path! -->
<!--   -->
<!--     #2) Specify 0 error variance -->
<!--     Nitrogen ~~ 0*Nitrogen -->
<!--  -->
<!--       #3) now, because we need to represent this as a latent variable -->
<!--       #show how species richness is an _indicator_ of nitrogen -->
<!--       Nitrogen =~ SA -->
<!--   -->
<!--     #4) BUT, make sure the variance of SA is estimated -->
<!--       SA ~~ SA -->
<!--   -->
<!--    #Regional Richness also has an effect -->
<!--     SA ~ SR -->
<!--   -->
<!--     #And account for the derivation of the square term from the linear term -->
<!--     logNcen2 ~ logN -->
<!--       ' -->
<!--   -->
<!--  # we specify std.lv=T so that the Nitrogen-SA relationship isn't fixed to 1 -->
<!--  compositeFit <- sem(compositeModel, data = seabloom, std.lv = TRUE) -->
<!--  -->
<!-- ```  -->
 

# Interactions
![](Figures/InteractionSEM.svg){width=70%}


# Autocorrelation (temporal, spatial)


# Test of mediation


