---
title: "modelling_basic"
output: html_document
header-includes:
   - \usepackage{svg}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# SEM basics
## What dataset to use, properties of data?


## Metamodel
![](../figures/Seabloom_Metamodel.svg){width=70%}


## Load data
```{r}
rm(list = ls())
data <- read.table("~/Swiss_SEM/data_preparation/CedarCreek_Seabloom/seabloom-2020-ele-dryad-data/cdr-e001-e002-output-data.csv",
                       sep=",", header=TRUE)
```


## Subset to one year
```{r}
data <- data[data$year == 2000, ]
```


## Linear model
- visualisation as DAG
- residuals
- variance/covariance matrix

![](../figures/LMvsSEM.svg){width=70%}

```{r}
lm1 <- lm(mass.above ~ nadd + rich + even + disk,  data = data)
summary(lm1)
plot(lm1)
```


## SEM, very simple example (same variables as in LM) 
- visualisation as DAG
- explain model output
- assessment of fit

![](../figures/SimpleSEM.svg){width=70%}


```{r}
library("lavaan")

sem1 <-
"mass.above ~ nadd + rich + even + disk
rich ~ nadd
even ~ nadd"

fit.sem1 <- sem(sem1, data = data)
```


### Scale variables
To reduce the difference in variances between the variables, we rescale them setting the mean to zero and the variance to one.
```{r}
data[, c(4, 7, 13:15)] <- apply(data[, c(4, 7, 13:15)], 2, scale)


fit.sem1 <- sem(sem1, data = data)
summary(fit.sem1, rsq = TRUE)
```



The model converged with poor fit:
- The ratio of the test statistic and the degrees of freedem should be **smaller than 2** (this ratio gives an indication how far away the model is from a decent fit)
- p-value should be larger than 0.05


### Modification indices
To improve the model we look for missing paths.

```{r}
modindices(fit.sem1, minimum.value = 3)
```

In the column `mi` (modification index) we look for high values...
Highest values are between `rich` and `even` and therefore, we include a correlation between them.

```{r}
fit.sem1.up <- update(fit.sem1, add = "rich ~~ even")
summary(fit.sem1.up, rsq = TRUE)
```




### Simple model: Random terms with piecewiseSEM

We can do the same in piecewiseSEM. The advantage is that we can include some random structure in the model. Let's take a look first at the model without random terms.

```{r}
library(piecewiseSEM)
library(nlme)

Psem1List <- list(
  lm(mass.above ~ rich + even + nadd + disk, data),
  lm(rich ~ nadd, data),
  lm(even ~ nadd, data),
  even %~~% rich
)


Psem1 <- as.psem(Psem1List)
summary(Psem1, .progressBar = F)
```

We see that the model fit is good (because we included the correlation between richness and evenness' errors).
The data was collected in plots within fields, whch adds a block effect to our structure. Let's try out with the random term.

```{r}

Psem1RandomList <- list(
  lme(mass.above ~ rich + even + nadd + disk, random = ~ 1|field, data),
  lme(rich ~ nadd, random = ~ 1|field, data),
  lme(even ~ nadd, random = ~ 1|field, data),
  even %~~% rich
)


Psem1Random <- as.psem(Psem1RandomList)
summary(Psem1Random, .progressBar = F)
```

We see here that the richness effect on biomass became non-significant.


## Saturated model
![](../figures/FullSEM.svg){width=70%}

```{r}
sem2 <-
"mass.above ~ nadd + rich + even + disk
rich ~ nadd + disk
even ~ nadd + disk

rich ~~ even"

fit.sem2 <- sem(sem2, data = data)
summary(fit.sem2, rsq = TRUE)
```


```{r}
modindices(fit.sem2, minimum.value = 3)
```
The modification indices shows that the model is saturated and thus, no further paths can be added to improve the model fit.


### Saturated model: Random terms with piecewiseSEM

Let's try again to add the random structure an compare lavaan and piecewise outputs.

```{r}

Psem2RandomList <- list(
  lme(mass.above ~ rich + even + nadd + disk, random = ~ 1|field, data),
  lme(rich ~ nadd + disk, random = ~ 1|field, data),
  lme(even ~ nadd + disk, random = ~ 1|field, data),
  even %~~% rich
)

Psem2Random <- as.psem(Psem2RandomList)
summary(Psem2Random, .progressBar = F)

```



### Pruning
```{r}
sem.prune <-
"mass.above ~ nadd + rich
rich ~ nadd
even ~ nadd 

rich ~~ even"

fit.sem.prune <- sem(sem.prune, data = data)
summary(fit.sem.prune)
```



## Model comparison
- add an additional variable or path, then compare the two SEM



## SEM with latent and composite variables
- difference between latent and composite variable
- SEM with latent variable(s)
- SEM with composite variable(s)

![](../figures/LatentCompositeSEM.svg){width=70%}


## SEM with interaction
![](../figures/InteractionSEM.svg){width=70%}


## SEM with autocorrelation (temporal, spatial) --> advanced?




