---
author: "Frank Pennekamp"
title: "Introduction to structural equation modelling"
subtitle: "Advanced modelling"
institute: 
- Department of Evolutionary Biology and Environmental Sciences
- University of Zurich
date: "9.11.2022"
format:
  revealjs: 
    smaller: false
    scrollable: false
    theme: simple
    slide-number: true
    show-slide-number: all
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(DiagrammeR)
library(ggplot2)
```

## Overview

- Advanced SEM topics covered today:
  - Latent variables  
  - Composite variables  
  - Interactions  
  - Complex survey designs    

<!-- - Temporal autocorrelation   -->
<!-- - Spatial autocorrelation   -->

<!-- <div class = "notes"> -->
<!-- Some notes to myself. -->
<!-- </div> -->

## Revisiting the meta-model

\centering
![](images/Metamodel.pdf){width=50%}

- Meta-model are conceptual models that allow to link data with theory. 
- So far, we have only worked with manifest (measured) variables.   
- However, some aspects of a meta-model may be difficult to quantify and measure directly.  
- This is because they represent an abstract, multifaceted concept (e.g., general intelligence).
- This is where latent and composite variables are needed.   

# Latent variables

## Latent variables

\centering
![](images/LatentSEM.pdf){width=50%}

- Latent variables are unobserved, but their influence is captured by indicator variable(s).  
- Graphically, latent variables are often represented by an oval node shapes (ellipses).  
- Direction of causality reversed: from latent variables to the observed variables (reflective indicators). 

```{r, out.width="50%", fig.align='center', include=F}
grViz("
digraph boxes_and_circles {
   
   node [shape=box]
   X1;X2;X3;Z;

   
   node [shape=circle]
   Y
    
    Y -> X1;
    Y -> X2;
    Y -> X3;
    Y -> Z;
    Z;
    
  X1->X2->X3 [style='invis']
  {rank = 'max'; Z}
  {rank = 'min'; X1}
  {rank = 'same'; X1;X2;X3}
}
")
```

## Latent variables

\centering
![](images/LatentSEM.pdf){width=50%}

- Indicator variables are emergent manifestation of the underlying phenomenon represented by the latent variable.   
- All indicators should be positively correlated to the latent variable (i.e., driver).
- In contrast to indicators, latent variables are free of random or systematic measurement errors.

## Latent variables

- Latents can be both endogenous and exogenous.
- *Measurement model* focuses solely on relating indicators to latent variables.
- *Structural model* is one with directed paths between latent variables.

## Latent variables

Latents often fitted in two steps:  

1) Confirmatory factor analysis
  - Multi-indicator latent variables test hypothesis that multiple indicator variables are generated by the same underlying process.    
  - Precursor to evaluation of any structural models in which the latent variables appear.
2) Full model including latent variable
  - To estimate effect of latent variable on other variables.

# Composite variables

## Composite variables

\centering
![](images/CompositeSEM.pdf){width=50%}

- Composite variables specify the influence of collections of variables (e.g., land use).
- In comparison to latent variables, composites arise from the indicators.  
- They are visualized by arrows pointing from the indicators to the composite (formative or causal indicators).
- Values are determined by its causes (indicators), thus error variance is set to 0.  
- Composites are shown as hexangular shapes.  

```{r, out.width="50%", fig.align='center', include=F}
grViz("
digraph boxes_and_circles {
   
   node [shape=box]
   X1;X2;X3;Z;

   
   node [shape=hexagon]
   Y
    
      X1 -> Y;
    X2 -> Y;
    X3 -> Y;
    Y -> Z;
    Z;
    
  X1->X2->X3 [style='invis']
  {rank = 'max'; Z}
  {rank = 'same'; X1;X2;X3}
}
")
```

## Key differences between latent and composite variables

\centering
![](images/LatentCompositeSEM.pdf){width=40%}

- Flow of causation in a latent variables is from the construct to its indicators, i.e., indicators are driven by an underlying, unmeasured process.   
- As a latent variable represents an underlying, data-generating process, its indicators need to be correlated to each other. 
- For composite variables, the flow of causation is reversed and the indicators are independent entities.   
- In the case of a composite variable, there is no assumption about the relation between the indicators. 

## Key differences between latent and composite variables

How distinguish latent and composites:

- Rule of thumb 1: if the indicators are redundant, they likely belong to a latent variable.   
- Rule of thumb 2: If the meaning of the construct changes after dropping one of the indicators, the construct likely is a composite.  

# Exercise

## Exercise:

- Revisit the meta-model you have drawn yesterday:
  - Which contructs could be modelled with a latent or composite variable?
  - Adapt your meta-model accordingly.

# Interactions

## Interactions

\centering

![](images/Interaction.pdf){width=50%}

- In nature, things often are contingent on each other.
- For instance, the effect of nutrients on plant growth, may depend on how disturbed the environment is.  
- Such a behaviour is called an interaction, which indicates that the effect of the two main effects are different when combined.  
- Both positive and negative interactions are possible.  
- In regression, the interaction is represented by a coefficient that estimates the effect of the product of the two predictors.  

```{r, out.width="50%", fig.align='center', include=F}
grViz("
digraph boxes_and_circles {

  # a 'graph' statement
  graph [overlap = true, fontsize = 10, layout = dot,
       rankdir = RL]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X1; X2; Y, middleman

  # several 'edge' statements
    X1->middleman[arrowhead=none];
    middleman->Y;
    middleman[shape=none width=0 height=0 label='' style=invis]
    X2->middleman [constraint=false];

}
")
```

## Interactions

Interactions can be modelled in different ways in lavaan:

1) Multiple groups
2) Composites

## Interactions (multi group)

```mod <- sem(model, group = "age_class", data = dd)```

- Multigroup fitting allows coefficients to vary among groups.  
- Lavaan offers the “group” argument to specify for which groups coefficients should be estimated.   
- Importantly, groups have to be categorical (e.g., sex, age class). 


## Interactions (multi group)

Lavaan allows to introduce equality constraints on various aspects via the `group.equal` argument:

```mod <- sem(model, group = "age_class", group.equal = c("regressions"), data = dd)```

Additional constraints could be:

```
group.equal=c(
"intercepts",
"means",
"regressions",
"residuals",
"residual.covariances")
```

## Interactions (multi group)

- Even more control by having the same name for different parameters: 

```
model <- ' 
y ~ c("b1", "b1") * x1 + c("b2", "b2") * x3
x2 ~ c("b3", "b4") * x1
x3 ~ c("b5", "b5") * x2
'
```

Same coefficients for all but the effect of x1 on x2.


# Heywood cases: when things go wrong

## Heywood cases : when things go wrong

- Improper solutions:  
  - Negative variances  
  - Correlations larger than 1  
- Reasons for the warnings can be:
  1) Slightly negative error estimates (not really a problem)   
  2) Indicators for latent variables need to be positively correlated   
  3) Local non-identification   
  4) General model misspecification   

# Complex sampling structure

## Complex sampling structure

- Needed when data is nested, e.g.,
  - Within sites.
  - Within groups such as families, nests. 
- Nesting violates the principle of independent and identically distributed observations.  
- Necessary to account for this structure in the data in the model.

## Complex sampling structure

```
library("lavaan.survey")
```

- The add-on package lavaan.survey allows the analysis of stratified, clustered or weighted data.  
- Lavaan objects are processed with a specific data structure:
  1) Initialize the design   
  2) Post-process the lavaan object and compute the adjusted results.
  3) Corrected lavaan object as result.

## Complex sampling structure

```
design <- svydesign(ids = ~ plot, strata = ~ field, 
nest = TRUE, data = dat)
summary(design)

fit.nested <- lavaan.survey(lavaan.fit = model, 
survey.design = design)
```

- Needed to specify the study design
- Here we have plots (`ids`) nested in fields (`strata`)
- Next, we can refit the `simple` model from before with `lavaan.survey` using the specified study design as an argument.

<!-- # Spatial autocorrelation -->

<!-- ## Spatial autocorrelation -->

<!-- - Why is autocorrelation problematic? -->
<!-- - Autocorrelation is a sign of non-independence, violating assumptions of linear models that data points are independent. -->
<!-- - Does not influence estimates, but their standard errors and p values. -->
<!-- - You think you have more information than you actually have. -->

# Questions?

# Live coding session

# Your turn: working with the Seabloom dataset

## Exercise 1

Start with the following model:

```
library("lavaan")

simple <-
"mass.above ~ nadd + disk + rich + even + precip.mm
rich ~ nadd + precip.mm
even ~ nadd + precip.mm

rich ~~ even"

fit.simple <- sem(simple, data = seabloom, estimator = "MLM")
summary(fit.simple)
```

## Exercise 2

- Construct latent variable diversity based on richness, evenness and ens.pie:
  - Run confirmatory factor analysis
  - What do you conclude?
  
## Exercise 3

- Construct latent variable diversity only based on richness and evenness:
  - Run confirmatory factor analysis
  - Include latent variable into full model
  - What do you conclude?
  
## Exercise 4

- Construct composite variable landuse based on nutrients and disturbance (disk):
  - What do you conclude?
  - Build composite manually.

## Exercise 5

- Investigate possible interaction between disturbance and nutrient addition on AGB:
  - Construct composite variable to capture a possible interaction:
  - What do you conclude?
  - Incorporate composite into full model
  
## Exercise 6

- Investigate possible interaction between disturbance and nutrient addition on AGB:
  - Use multi-group fitting to explore interaction.
  - What do you conclude?
  
## Exercise 7

- Account for nested experimental design with the `lavaan.survey` package:
  - Add individual plots nested in fields.


