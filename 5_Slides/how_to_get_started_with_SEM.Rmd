---
title: "Introduction to structural equation modelling"
subtitle: "Basic modelling"
author: "Frank Pennekamp"
institute:
- Department of Evolutionary Biology and Environmental Sciences
- University of Zurich
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output:
  beamer_presentation:
    latex_engine: xelatex
    theme: metropolis 
    incremental: true
    toc: no
header-includes: \usepackage{booktabs}
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(DiagrammeR)
library(ggplot2)
```

## Quick introduction of participants

- Who are you?
- Why do you want to learn about SEM?
- What is your research question for day 3?

# General information 

## Introduction of the **Swiss SEM team**

- Dr. Frank Pennekamp (main instructor)   
- Dr. James Grace (advanced topics and model clinic)   
- Dr. Rachel Korn (course development)   
- Dr. Noémie Pichon, Dr. Fletcher Halliday, Dr. Eliane Meier, Dr. Hugo Saiz, Dr. Debra Zuppinger-Dingley, Rebecca Oester, Annabelle Constance, Fabienne Wiederkehr (course development)

\centering
![](images/Swiss_SEM_team.png){width=50%}

## Schedule & content

- *Day 1*:
  * General introduction to SEM to model ecological systems
  * Fitting SEMs to data (live demo)
  * Model pruning, visualization and reporting
  * Discussion with James Grace
- *Day 2*:
  * Latent and composite variables
  * Interactions
  * Complex sampling designs
  * Discussion with James Grace
- *Day 3*:
  * Self-study with possibility to meet with instructor(s)

## Overview

- What the course is about:  
  - Global estimation with R package lavaan
  - Hands on exercises and live coding
  - We will work with a single, ecological dataset (Seabloom et al. 2020)
- What will not be covered   
  - Local estimation of SEMs (with piecewiseSEM)
  - Advanced topics like incorporating random effects, feedbacks, temporal autocorrelation

## Learning objectives

- Participants understand the advantages and limits of SEMs to draw inferences from data
- Participants are able to fit, interpret and visualize a SEM with `lavaan`.
- Participants are able to apply SEM to their own dataset

# Getting started with Structural Equation Modeling

## Research questions

<!-- Comments: -->
<!-- Each slide represents a concept/topic to teach. Can be expanded to more slides. -->
<!-- Content must be revisited to be consistent in wording, concepts etc. -->
<!-- Specially required feedback on causality, meta-model, backdoor criterion, loops. -->
<!-- Concepts for technical part that could be introduced also here: global vs local, information criteria for arrow selection (for me better on technical part). -->

\centering
![](images/ecosystem.jpg){width=30%}

- Ecology is about the interactions between organisms and their environment.  
- We often have ideas how things could be connected in ecological systems.   
- To test hypotheses, we need a way to dissect when they occur for a reason versus randomness.  
- We use statistics to understand what is signal and what is noise.
- Research questions are often about cause and effect.  

<!-- Ask students about their research questions -->

## Why do we need to use SEM in Ecology

<!-- Here we ask students about what is a SEM, why they want to learn them etc. -->

- Promotes system thinking:
  - "Understanding the whole rather than the parts in isolation" 
- SEM unites multiple variables in a single causal network: simultaneous tests of multiple hypotheses.  
- Causality is central: 
  - SEM assumes that the specified relationships among variables represent causal links.  

## Causality

\centering
![](images/correlation.jpg){width=40%}

- "Correlation does not imply causation".
- Everything else being equal, seeing variation in X leading to variation in Y.
- Experiments to isolate effect of X on Y.
- Experiments not always feasible, hence development of SEM.

<!-- - Explain the concept and discuss with students the topic.  -->
<!-- - Show the difference between direct effects and correlation together with the graphical representation.   -->

# Differences and similarities between SEM and regression models

## Regression models vs SEM

- We often have multiple observed variables.  
- Include terms to test for interactions. 
- We want to test and evaluate multivariate causal relationship.  
- Test direct and indirect effects on assumed causal relationships.  
- Incorporate observed and latent variables.  

## Two goals of SEM: 

1)  Understand the underlying causal network driving the correlation/covariance among a set of variables.  
2)  Explain as much of their variance as possible with the model specified.  

## Thinking about the model  

A SEM is usually specified based on theory to determine and validify a proposed causal process and/or model.  

Which variables to include?     

- Supported by theory.  
- Ecologically meaningful.  
- Garbage in - garbage out (both data quality and ecologically meaningful).  

## SEM modelling philosophy 

- Continuum between theory (hypothesis-driven) to exploratory (data-driven) modelling.  
- Important to be explicit about the approach taken.     

<!-- - Importance of being aware about what the model is telling to us.   -->
<!-- - Final discussion about what SEM provides and the importance of system thinking in ecology.   -->

# Introduction to the dataset

## Introduction to the dataset

![](images/CedarCreek.jpg)   

We will use an experimental dataset collected at the Cedar Creek Ecosystem Science Reserve to  examine long-term consequences of human-driven environmental changes ecosystem responses to:

- Disturbance   
- Nitrogen deposition   
- Changes in precipitation  

## Introduction to the dataset

Research questions:

1) How has aboveground biomass changed as a function of disturbance (disking) and nutrient addition?   
2) How are these effects mediated by diversity?  

## Introduction to the dataset

\centering
![](images/CedarCreek_map.png){width=40%}

Location of the study site (Cedar Creek Ecosystem Science Reserve), the location of the three study fields within the reserve, and location of the 35 x 55 m intact (black) and disturbed (red) plots within each field. 

## Introduction to the dataset

\centering
![](images/CedarCreek_exp_design.png){width=50%}

Location of the 4 x 4 m nutrient treatment plots within each 35 x 55 m Intact or Disturbed plot within each of three fields (A, B, and C). Letters indicate the nutrient treatments. 

## Introduction to the dataset

\centering
![](images/AGB_disturbance.pdf){width=100%}


Effect of soil disturbance (disking) and nutrient enrichment on live, aboveground plant biomass. Colors indicate nutrient addition treatment: Control and NPK+ (all nutrients plus 9.5 g N m-2 yr-1). 

## Introduction to the dataset

\centering
![](images/AGB_diversity.pdf){width=100%}
Effect of soil disturbance (disking) and nutrient enrichment on (a) diversity (ENSPIE), (b) richness (S, species 0.3 m−2), and (c) evenness (ENSPIE S−1). 


## Question of interest: what is the effect of richness on biomass?

\centering
![](images/Seabloom_PathDiagram.pdf){width=70%}

<!-- Ask students about how they would address this question. -->

## Meta-model

\centering
![](images/Metamodel.pdf){width=50%}

Meta-model are conceptual models that allow to link data with theory.   

1) Productivity (biomass) is directly influenced by the environment (nutrients, disturbance and precipitation)
2) Productivity (biomass) is directly influenced by biodiversity (richness and evenness). 
3) The environment also influences biodiversity and thus, have an indirect effect on productivity via biodiversity.


<!-- - Thinking about what is missing in the model, measurement errors etc.  -->
<!-- - Present the concept of meta-model and impications for research.  -->
<!-- - Include a graphical representation of the meta-model as what is missing in the model.  -->

```{r, echo=F, out.width="50%", fig.align='center', include=F}
grViz("
digraph boxes_and_circles {

  # a 'graph' statement
  graph [overlap = true, fontsize = 10, layout = dot,
       rankdir = RL]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X; Y;

  # 'edge' statements
  X -> Y
}
")

grViz("
digraph boxes_and_circles {

  # a 'graph' statement
  graph [dir = both, arrowhead=normal,overlap = true, fontsize = 10, layout = dot, 
       rankdir = RL, splines=curved]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  Y; X; 

  # 'edge' statements
  X -> Y [dir=both]
}
")


```

## Graphical models:  

```{r, echo=F, out.width="50%", fig.align='center'}
grViz("
digraph boxes_and_circles {

  # a 'graph' statement
  graph [overlap = true, fontsize = 10, layout = dot,
       rankdir = RL]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X; Y;

  # 'edge' statements
  X -> Y
}
")
```

- Directed acyclic graphs (no loops).   
- Variables are nodes (boxes).   
- Edges (one-headed arrows) are causal relationships such as X affects Y.   
- Edges (two-headed arrows) are non-causal relationships such as X and Y are correlated. 

# Exercise: 

## Exercise: 

- Draw a meta-model of the dataset you will work with on Thursday.
- Make a table with putative causal relationships. 

## A simple bivariate model.

\centering ![](images/LM.pdf){width=50%}

\centering ```lm(biomass ~ precipitation)```

- Linear regression     
- Regression coefficient quantifies the strength of relationship   
- Change in Y for one unit change in X   

<!-- Present the bivariate model. -->
<!-- Include the equation and a plot. -->
<!-- It is important that students understand that all they know can be defined with a graphical representation. -->


## Multiple independent variables

\centering
![](images/LMdir.pdf){width=50%}

\centering ```lm(biomass ~ precipitation + nutrients + ...)```

- Often more than one independent variable important $\rightarrow$ multiple regression   
- Estimates partial regression coefficients (i.e. effect of precipitation on biomass when nutrient addition is fixed)    
- Only direct effects.

<!-- - Discuss with students other variables that may affect B.   -->
<!-- - Introduce a new variable and the question that it answers.  -->
<!-- - Add nutrient variable.  -->
<!-- - Show the graphical model (X1 -> Y, X2 -> Y).  -->
<!-- - Include the equation and the two partial plots.  -->
<!-- - Be clear this is a multiple regression model.  -->



```{r, out.width="50%", fig.align='center', include=F}
grViz("
digraph boxes_and_circles {

  # a 'graph' statement
  graph [overlap = true, fontsize = 10, layout = dot,
       rankdir = RL, splines=curved]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  Y; X1; X2; X3;

  # several 'edge' statements
    X1->Y;
    X2->Y;
    X3->Y;

}
")
```

# From regression models to SEM

## SEM: variance-covariance matrix

```{r}
set.seed(5)
x <- rnorm(30, sd=runif(30, 2, 50))
d <- matrix(x, 10)
V <- cov(d)
V
```

- Comparison of specified SEM to observed variance-covariance matrix
- The variances appear along the diagonal and covariances appear in the off-diagonal elements

## SEM: correlation matrix

```{r}
set.seed(5)
x <- rnorm(30, sd=runif(30, 2, 50))
d <- matrix(x, 10)
V <- cov(d)
cov2cor(V)
```

- Correlation matrix is standardized variance-covariance matrix


## Multiple independent variables

\centering
![](images/LMind2.pdf){width=50%}

\centering ```lm(richness ~ nutrients)```  
\centering ```lm(evenness ~ nutrients)```   
\centering ```lm(biomass ~ richness + evenness)```

- Indirect effect is the effect of an independent variable on a dependent variable through one or more intervening or mediating variables.   
- Indirect effects can be quantified by the product of the compound path.

```{r, out.width="50%", fig.align='center', include=F}
grViz("
digraph boxes_and_circles {

  # a 'graph' statement
  graph [overlap = true, fontsize = 10, layout = dot, splines = curved,
       rankdir = RL]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X1; X2, Y

  # several 'edge' statements
    X1->X2[style=dashed];
    X2->Y[style=dashed];
    X1->Y;
}
")
```

## Mediation

\centering ![](images/LMind2_full_mediation.pdf){width=40%}  

<!-- \centering ![](images/LMind2_partial_mediation.pdf){width=30%}   -->

\centering ![](images/LMind2_no_mediation.pdf){width=40%}  

- Tests whether a particular variable has a mediating effect on a path.  
- Often used to test underlying mechanisms.
- In our example, we could ask whether the effect of nutrients on biomass is mediated through biodiversity.
- Possibilities: complete mediation, partial mediation, no mediation.     

## System level approach

<!-- - Show a very complex model including multiple types of variables, arrows (direct and correlations) for the study system.  -->
<!-- - The complex model is built based on submodels, each one addressing specific questions.  -->
<!-- - We need a framework to analyze this together -> SEM  -->
<!-- - Discuss about complexity in ecology and if SEM is useful to answer your questions ("We need to do things as simple as possible, but no simpler").  -->

\centering
![](images/FullSEM.pdf){width=50%}


```{r out.width="30%", fig.align='center', include=F}
grViz('
digraph boxes_and_circles {
   
      graph[layout=dot]
      
    subgraph {
    
    node[shape=box]
    a -> b[color=black, penwidth=3.0, label="0.5"]
    a -> c[color=black, penwidth=3.0, label="0.5"]
    c -> b[color=red, penwidth=1.5, label="-0.25"]
    c -> e[color=red, penwidth=1.5, label="-0.25"]
      }
      
      
    subgraph {
           
    node[shape=box]

    e -> e[color=black, penwidth=3.0, label="0.5"]
    e -> b[color=red, penwidth=1.5, label="-0.25"]

      }
       
      
{rank = "same"; c;e}


}
')
```

- \alert{Exogenous} variables only have paths emanating from them (i.e., do not have arrows going into them).
- \alert{Endogenous} variables have paths directed into them. 
- An endogenous variable can also have arrows directing out of it, but the sole condition is that they must be predicted.  

## Grace's 8 rules of path coefficients
<!-- https://jslefche.github.io/sem_book/global-estimation.html -->

1) Unspecified relationships among exogenous variables are their bivariate correlations.  
2) When two variables are connected by a single path, the coefficient of that path is the regression coefficient.  
3) The strength of a compound path (one that includes multiple links) is the product of the individual coefficients.  
4) When variables are connected by more than one pathway, each pathway is the ‘partial’ regression coefficient.  

## Grace's 8 rules of path coefficients

5) Errors on endogenous variables relate the unexplained correlations or variances arising from unmeasured variables.  
6) Unanalyzed (residual) correlations among two endogenous variables are their partial correlations.  
7) The total effect one variable has on another is the sum of its direct and indirect effects.  
8) The total effect (including undirected paths) is equivalent to the total correlation.   

## Goodness-of-fit

- *$\chi^2$ statistic*: good fit when failing to reject the null hypothesis that the $\chi^2$ statistic is different from 0 \alert{(P > 0.05)}.   
- *Comparative fit index (CFI)*: this statistic considers the deviation from a ‘null’ model. In most cases, the null estimates all variances but sets the covariances to 0. A value > 0.9 is considered good. 
- *Root-mean squared error of approximation (RMSEA)*: statistic penalizes models based on sample size. A value < 0.10 is acceptable, and anything < 0.08 is good.  
- *Standardized root-mean squared residual (SRMR)*: the standardized difference between the observed and predicted correlations. A value < 0.08 is considered good.   

## Assumptions of SEM with lavaan

  - (Multivariate) normality of endogenous variables
  - Global estimation based on variance-covariance matrix[^1]
  - Directed (acyclic) relationships[^2]
  - Linear relationships[^3]

[^1]: Local estimation possible.
[^2]: Causal loops possible.
[^3]: Nonlinear relationships possible.

## Model identifiability

- Underidentified: not enough pieces of information to identify parameters uniquely (df < 0).  
- Saturated: Just enough information to uniquely identify parameters, but no df to check model fit (df = 0).  
- Over-identified: parameters can be uniquely identified and positive dfs to test model goodness-of-fit (df > 0).   

## Model identifiability

"t-rule" to quickly gauge whether a model is under-, just, or overidentified: 

$$ t \leq \frac{n (n + 1 )}{2} $$

*t* = number of unknowns (parameters to be estimated, i.e. variances & covariances)   
*n* = number of knowns (observed variables). 

The LHS is how many pieces of information we want to know.   
RHS: information we have (number of unique cells in the observed variance-covariance matrix).  

## Data requirements

- Replication should be at least 5x the number of estimated coefficients (not error variances or other correlations).
- To estimate two relationships, at least n = 10 required to fit model.
- Ideally, replication is 5-20x the number of estimated parameters. 
- The larger the sample size, the more precise (unbiased) the estimates. 


## SEM workflow in a nutshell

1) Review the relevant theory and research literature to support model specification 
2) Specify a model (e.g., diagram) 
3) Determine model identification 
4) Select measures for the variables represented in the model
5) Collect data
6) Conduct preliminary descriptive statistical analysis (e.g., scaling, missing data, collinearity issues, outlier detection)
7) Estimate parameters in the model
8) Assess model goodness-of-fit
9) Check for missing or unnecessary links
10) Interpret and present results visually

# Lavaan syntax

## Lavaan syntax

Define model:
```
simple <-
"mass.above ~ nadd + rich + even + precip.mm + disk
rich ~ nadd + precip.mm
even ~ nadd + precip.mm"
```

Fit model:
```
fit.simple <- sem(simple, data = seabloom)
```

## Lavaan syntax

| Formula type | R | Meaning | Example |
| :----- | :----- | :----- | :----- |
| regression  | `~` | is regressed on | `y ~ x` |
| correlation | `~~` | correlate errors for | `y1 ~~ y2` |
| latent | `=~` | set reflective indicators | `Height =~ y1 + y2 + y3` |
| composite | `<~` | set formative indicators | `Comp1 <~ 1*x1 + x2 + x3` |
| intercept | `~ 1` | estimate mean for `y` | `y ~ 1` |
| labelling | `*` | name coefficients | `y ~ b1*x1 + b2*x2` |
| defining | `:=` | define quantity | `Total := b1*b3 + b2` |

# Questions?

# Live coding session

# Your turn: working with the Seabloom dataset

## Exercise 1

- Exploration of dataset (variables and treatments)
- Check collinearity and normality
- Fitting linear models to estimate coefficients
  - Multiple regression (direct effects of predictors on AGB)
  - Multiple regression (indirect effects on richness and evenness)
  - What can you conclude?

## Exercise 2

\centering
![](images/SimpleSEM.pdf){width=50%}

- Fitting of above SEM to Seabloom data:
	- Assess model goodness of fit.
	- Investigate the modification indices. Are there paths to add that are reasonable?
	- Check model summary.
	- What can you conclude?

## Exercise 3

\centering
![](images/SimpleSEM.pdf){width=50%}

After finding a model with good fit:

- Model analysis:
	- Calculate the standardized coefficients.
	- Add derived quantities (direct and indirect effects of nutrients and disturbance).

## Exercise 4

\centering
![](images/FullSEM.pdf){width=50%}

- Saturated model:
  - Model comparison with simpler models used previously.
  - Perform model pruning.
  - Decide on most parsimonious model and summarize model.
  - What do you conclude?

## Exercise 5

\centering
![](images/FullSEM.pdf){width=50%}

- Perform mediation analysis:
  - Is the effect of disturbance mediated via its effect on richness and eveness, rather than directly on biomass?
  - Add paths from disturbance to richness and evenness, remove the direct paths to AGB (both nutrients and disturbance).
  - Compare model fit to simple model. What do you conclude?




  

