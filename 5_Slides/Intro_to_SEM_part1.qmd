---
title: "Introduction to structural equation modelling"
subtitle: "Day 1: Basic modelling"
author: "Frank Pennekamp"
institute:
- Department of Evolutionary Biology and Environmental Sciences, University of Zurich
date: "11/5/2025"
date-format: long
format:
  revealjs: 
    smaller: false
    scrollable: false
    theme: simple
    slide-number: true
    show-slide-number: all
    footer: Introduction to SEM (2025)
    width: 1200
    height: 1000
editor:
  render-on-save: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align='center')

library(DiagrammeR)
library(ggplot2)
library(knitr)
```

## Quick introduction of participants

-   Who are you?
-   What is your research question?
-   What do you know about SEM already?

# General information

## Acknowledgements {.smaller}


\centering

![](images/Swiss_SEM_team.png){width="100%"}

-  Dr. No√©mie Pichon, Dr. Fletcher Halliday, Dr. Eliane Meier, Dr. Hugo Saiz, Dr. Debra Zuppinger-Dingley, Rebecca Oester, Annabelle Constance, Fabienne Wiederkehr (course design)
-  Dr. Rachel Korn (course development: exercises and solutions)
-  Dr. Frank Pennekamp (course development: exercises, solutions and slides, instructor)

## Schedule & content {.smaller}

-   *Day 1*:
    -  General introduction to SEM to model ecological systems (lecture)
    -  Fitting SEMs to data (live demo)
    -  Case study: fitting SEMs to data (exercises)
    -  Work on your research question /  meta-model (self-study)
-   *Day 2*: 
    -  Constructs: latent and composite variables (lecture)
    -  Fitting SEMs to data (live demo & case study exercises)
    -  Work on your research question /  SEM model (self-study)
-   *Day 3*:
    -  Progress update
    -  Model visualization (lecture)
    -  Work on your research question /  SEM model (self-study)
    -  Presentation of your SEM model and discussion with instructor and peers

## Overview {.smaller}

-   What the course is about:
    -   Global estimation of SEMs with R package lavaan (including latents and composites)
    -   Hands-on exercises and live coding
    -   A single ecological dataset for demonstration (Seabloom et al. 2020)
    -   Develop your own SEM model

.  .  .  

-   What will *not* be covered
    - Local estimation of SEMs (with R package piecewiseSEM)
    - Advanced topics:
      + integrate random effects
      + disentangle feedback loops
      + dealing with spatial and temporal autocorrelation

## Learning objectives

You can:

::: incremental
  - translate your research question into a meta-model.
  - fit a SEMs with the R package `lavaan`.
  - assess the quality of a fitted SEM  
  - interpret your SEM model and those reported by others.
   - present SEMs graphically.
:::

<!-- ## Course materials

[Slide decks and R code available on github](https://github.com/pennekampster/Swiss_SEM/)
  -->

# Getting started with Structural Equation Modeling

## Understanding (ecological) systems {.smaller}

<!-- Comments: -->

<!-- Each slide represents a concept/topic to teach. Can be expanded to more slides. -->

<!-- Content must be revisited to be consistent in wording, concepts etc. -->

<!-- Specially required feedback on causality, meta-model, backdoor criterion, loops. -->

<!-- Concepts for technical part that could be introduced also here: global vs local, information criteria for arrow selection (for me better on technical part). -->

::: {.incremental}
::: columns
::: {.column width="50%"}
-   Ecological systems characterized by complex network of interactions between organisms and the environment.
-   Research questions are often about cause-effect relationships.
-   Create hypotheses about how things could be connected in ecological systems (e.g., species interactions, drivers). 
-   Test these hypotheses using data and statistics.
:::

::: {.column width="50%"}
![](images/ecosystem.jpg)
:::
:::
:::

::: notes

:::


## Why is understanding causes important? {.smaller}

::: {.incremental}
::: columns
::: {.column width="50%"}
- Causes = mechanisms
  + Allows us to predict the behaviour of a system
  + Justify interventions (e.g., eradication of invasive species, habitat restoration for threatened species)
- What is the problem?
  + Confounding of cause with non-cause (e.g., avoid interventions with no or detrimental effects)
:::

::: {.column width="40%"}
![](images/quagga.jpeg)
:::
:::
:::


## Causality

> "Correlation does not imply causation"

::: {.incremental}
::: columns
::: {.column width="50%"}
- Causation: causing variation in X leading to variation in Y (=X causes Y), everything else being equal.
- Experiments required to isolate effect of X on Y.
- Randomized controlled trials as gold standard to infer causes
- Problem: conducting experiments can be unethical or unfeasible.
:::

::: {.column width="40%"}
![](images/correlation.jpg)
:::
:::
:::

::: notes
-   Example shown: is this correlation or causation? 
:::



## "Correlation can indicate causation" 


> A simple correlation implies an unresolved causal structure, since we cannot know which is the cause, which is the effect, or even if both are common effects of some third, unmeasured variable.    
Bill Shipley (Cause and correlation in biology, 2004)

::: {.incremental}
::: columns
::: {.column width="100%"}
- Inferring causes from observations is possible, but requires to rule out confounding.
- What is confounding?



:::

::: {.column width="0%"}
:::
:::
:::

## Confounding

> Confounding occurs when an outside variable influences both the independent variable (X) and the dependent variable (Y), creating a false impression of a causal relationship between them. This can lead to incorrect conclusions about the nature of the relationship.


```{dot}
digraph confounding_classic {
  rankdir = LR;
  
  node [shape = box, fontname = Helvetica, color = "gray"];
  U [label = "U\n(Unobserved\nConfounder)", color = "red"];
  X [label = "X\n(Predictor)"];
  Y [label = "Y\n(Outcome)"];
  
  U -> X [color = "red", penwidth = 2];
  U -> Y [color = "red", penwidth = 2];
  X -> Y [style = "dashed"];
  
  label = "Example 1: Classic Confounding\nU affects both X and Y";
  labelloc = "b";
}

```



## Confounding example

Correlation between ice cream sales and cases of drowning are both influenced by temperature (confounder).

```{r, dev = "png", fig.align='center', .nostretch}

#| out-width: 12in
#| out-height: 3.5in

# Demonstrating Confounding: Ice Cream Sales vs Drowning Deaths
# A classic example showing how correlation does not imply causation

# Load required libraries
library(tidyverse)
library(ggplot2)
library(corrplot)

# Create synthetic data based on realistic patterns
set.seed(42)

# Temperature is the confounder (in Celsius)
temperature <- seq(5, 35, length.out = 12)  # Monthly temperatures

# Ice cream sales increase with temperature
ice_cream_sales <- 100 + 50 * temperature + rnorm(12, 0, 30)
ice_cream_sales <- pmax(ice_cream_sales, 0)  # Ensure non-negative

# Drowning deaths increase with temperature (people swim more)
drowning_deaths <- 10 + 2 * temperature + rnorm(12, 0, 3)

# Create a data frame
data <- tibble(
  month = month.abb,
  temperature = temperature,
  ice_cream_sales = ice_cream_sales,
  drowning_deaths = drowning_deaths
)

# Create scatter plot showing the correlation
scatter_plot <- data %>%
  ggplot(aes(x = ice_cream_sales, y = drowning_deaths)) +
  geom_point(size = 4, color = "steelblue", alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "red", fill = "red", alpha = 0.2) +
  labs(
    title = "Ice Cream Sales vs Drowning Deaths",
    subtitle = "Is this causal",
    x = "Ice Cream Sales (arbitrary units)",
    y = "Drowning Deaths (count)",
    caption = paste("Correlation:", round(cor(data$ice_cream_sales, data$drowning_deaths), 3))
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 12, color = "darkred"),
    panel.grid = element_line(color = "lightgray")
  )

print(scatter_plot)

```

.  .  .

```{dot}
// Example 2: Ice cream sales and drowning
// Temperature is the confounder
digraph confounding_icecream {
  rankdir = LR;
  
  node [shape = box, fontname = Helvetica, color = "gray"];
  Temperature [label = "Temperature"];
  IceCreamSales [label = "Ice Cream\nSales"];
  Drowning [label = "Drowning\nDeaths"];
  
  Temperature -> IceCreamSales;
  Temperature -> Drowning;
  IceCreamSales -> Drowning [style = "dashed", label = "Spurious correlation"];
  
  labelloc = "b";
}
```



## Causal diagram

::: {.incremental}
-   Graph specifying putative cause-effect relationships.
-   Data-generating mechanisms lead to a set of observational expectations.
-   Formalized as Directed Acyclic Graphs (DAGs).
:::

## Directed acyclic graphs {.smaller}

::: {.incremental}
::: columns
::: {.column width="50%"}
- Directed = unidirectional. 
- Acyclic = no cyclces (=causal loops) permitted.
- Variables are nodes (boxes). 
- Edges (one-headed arrows) are causal relationships such as X affects Y.  
- Edges can have any functional shape. 
- Omitted links and nodes have empirical implications (= assumptions about the causal diagram)
- U variables represent unmeasured causes.
:::

::: {.column width="50%"}
```{dot}
//| fig-width: 4
digraph {

  # a 'graph' statement
  graph [overlap = true, fontsize = 15, layout = dot, ranksep = equally,
       rankdir = Tb];

  # 'node' statements
  node [shape = box,
        fontname = Helvetica];
  X; Y;

  # 'edge' statements
  X -> W;
  X -> Z;
  W -> Y;
  Z -> Y;
  
 node [shape = plaintext,
        fontname = Helvetica];
  U_w  -> W;
  U_x -> X;
  U_y -> Y;
  U_z -> Z;
  
  U_w [label = <U<SUB>w</SUB>>];
  U_x [label = <U<SUB>x</SUB>>];
  U_y [label = <U<SUB>y</SUB>>];
  U_z [label = <U<SUB>z</SUB>>];
 
 
 # control the placement of elements on the graph 
 {rank = min; U_x };
 {rank = same; Z ; W;};
 {rank = max; U_y};

  }
```
:::
:::
:::

## How can we determine causality? 
> The combination of knowledge of correlations with knowledge of causal relations, to obtain certain results, is a different thing from the deduction of causal relations from correlations.‚Äù    
Sewell Wright, 1923

::: {.incremental}
::: columns
::: {.column width="100%"}
- Build knowledge from past observation
- Design and conduct experiments
- Test hypotheses
- Develop theory 
:::

::: {.column width="0%"}
:::
:::
:::




## How can we evaluate causality? 
- Build a hypothesized causal diagram
![](images/A_priori_SEM.jpg){width="50%"}

## How can we evaluate causality? 
- Build a hypothesized causal diagram
- Collect data

## How can we evaluate causality? 
- Build a hypothesized causal diagram
- Collect data
- Test data against diagram, extract inferences
![](images/Final_SEM.jpg){width="50%"}

## How can we evaluate causality? 
- Build a hypothesized causal diagram
- Collect data
- Test data against diagram, extract inferences
![](images/Final_SEM.jpg){width="50%"}
- Repeat!


:::notes
https://www.nature.com/articles/ncomms10541
:::





## Biodiversity-ecosystem functioning {background-image="images/meadow.JPG" background-opacity="0.4"}

```{dot}
//| fig-width: 10
digraph G {

  graph [overlap = false, fontsize = 10, layout = dot, ranksep = .7,
       rankdir = TB]


  bgcolor="transparent"
  resources -> function;
  diversity -> function;
  environment -> function;
  
}
```

## Regressions

::: {.incremental}
::: columns
::: {.column width="50%"}
-   Relates observed variables to each other.
-   Only direct effects on Y considered.
-   Correlations between predictors ignored, unless very high (r >0.9). 
:::

::: {.column width="50%"}

```{dot}
//| fig-width: 4

digraph {

  # a 'graph' statement
  graph [overlap = false, fontsize = 10, layout = dot, ranksep = .7,
       rankdir = TB]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X1 [label = <X<SUB>1</SUB>>]
  X2 [label = <X<SUB>2</SUB>>]
  X3 [label = <X<SUB>3</SUB>>]
  Y
  E [label = <&epsilon;>, shape = plaintext]
  
  # 'edge' statements
  X1 -> Y
  X2 -> Y
  X3 -> Y
  E -> Y  [minlen = .1]
  
  X1:n -> X2:n [dir=both, minlen = 5 style="dashed"]
  X2:n -> X3:n [dir=both, minlen = 5 style="dashed"]
  X1:n -> X3:n [dir=both, minlen = 10 style="dashed"]
  
 # control the placement of elements on the graph 
{rank = same; X1 ; X2; X3}
{rank = max; E}

  
}
```


:::
:::
:::


::: notes
-   Explain the concept and discuss with students the topic.
-   Show the difference between direct effects and correlation together with the graphical representation.
:::


## A simple linear regression

`lm(biomass ~ precipitation)`

```{dot}
//| fig-width: 5
//| fig-height: 2

digraph  {

  # a 'graph' statement
  graph [overlap = false, fontsize = 10, layout = dot, ranksep = .7,
       rankdir = TB]

   # 'node' statements
  node [shape = box,
        fontname = Helvetica];
        
  X1 [label = precipitation]
  X2 [label = biomass]

  # 'edge' statements
  X1 -> X2
 # control the placement of elements on the graph 
{rank = same; X1 ; X2}
}

}
```



::: {.incremental}
-   Regression coefficient quantifies the direction and strength of relationship.\
-   How much change in Y for one unit change in X.
::: 

## Multiple regression {.smaller}

 `lm(biomass ~  nutrients + precipitation + richness + evenness)`

```{dot}
//| fig-width: 4
//| fig-height: 4

digraph  {

  # a 'graph' statement
  graph [overlap = false, fontsize = 15, layout = neato, rankdir = LR, splines = curved]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
        
  X1 [pos = "0,-1!", label = nutrients]
  X2 [pos = "0,-2!",label = precipitation]
  X3 [pos = "0,-3!",label = richness]
  X4 [pos = "0,-4!",label = evenness]
  Y  [pos = "2,-2.5!",label = biomass]

  # 'edge' statements
  X1 -> Y:w 
  X2 -> Y:w
  X3 -> Y:w
  X4 -> Y:w
  
  X1:w -> X2:w [constraint=false, dir=both]
  X2:w -> X3:w [dir=both]
  X1:w -> X3:w [dir=both]
  X1:w -> X4:w [dir=both]
  X2:w -> X4:w [dir=both]
  X3:w -> X4:w [dir=both]
  
}

```



::: {.incremental}
-   More than one independent variable\
-   Estimates partial effects (i.e. effect of precipitation on biomass when nutrient addition is fixed)\
:::

<!-- - Discuss with students other variables that may affect B.   -->

<!-- - Introduce a new variable and the question that it answers.  -->

<!-- - Add nutrient variable.  -->

<!-- - Show the graphical model (X1 -> Y, X2 -> Y).  -->

<!-- - Include the equation and the two partial plots.  -->

<!-- - Be clear this is a multiple regression model.  -->


## Biodiversity-ecosystem functioning {background-image="images/meadow.JPG" background-opacity="0.4"}

```{dot}
//| fig-width: 10
digraph G {

  graph [overlap = false, fontsize = 10, layout = dot, ranksep = .7,
       rankdir = TB]


  bgcolor="transparent"
  resources -> function;
  diversity -> function;
  environment -> diversity;
  environment -> resources;
  
  
}
```

## Structural equation model {.smaller}

::: {.incremental}
-   Multiple (regression) equations in a single framework.
- Embraces the correlations between variables.
-  Allow understanding of potentially causal relationships between variables (= system thinking).
-   Allow testing both direct and indirect effects.
-   Can incorporate observed and unobserved variables.

::: {layout-ncol="3"}
```{dot}
//| fig-width: 3
digraph {

  # a 'graph' statement
  graph [overlap = false, fontsize = 10, layout = dot, ranksep = .7,
       rankdir = TB]

   # 'node' statements
  node [shape = box,
        fontname = Helvetica];
        
  X1 [label = <X<SUB>1</SUB>>];
  X2 [label = <X<SUB>2</SUB>>];
  X3 [label = <X<SUB>3</SUB>>];

  # 'edge' statements
  X1 -> X2;
  X2 -> X3;
  
 # control the placement of elements on the graph 
{rank = same; X1 ; X2; X3};
}

}
")
```

```{dot}
//| fig-width: 3
digraph box2 {

  # a 'graph' statement
  graph [overlap = false, fontsize = 10, layout = dot, ranksep = .7,
       rankdir = TB];

  
  # 'node' statements
  node [shape = box,
        fontname = Helvetica];
        
  X1 [label = <X<SUB>1</SUB>>];
  X2 [label =<X<SUB>2</SUB>>];
  X3 [label = <X<SUB>3</SUB>>];
  U1 [label = <U<SUB>1</SUB>>];

  # 'edge' statements
  U1 -> X1;
  U1 -> X2;
  U1 -> X3;

 # control the placement of elements on the graph 
{rank = same; X1 ; X2; X3};
}
")

```

```{dot}
//| fig-width: 3
digraph {

  # a 'graph' statement
  graph [layout = neato, overlap = true, fontsize = 10, ranksep = .7,
       rankdir = TB];

  
  # 'node' statements
  node [shape = box, fontname = Helvetica];
        
  X1 [pos = "-4,-1!" label = <X<SUB>1</SUB>>];
  X2 [pos = "-3,-1!" label = <X<SUB>2</SUB>>];
  X3 [pos = "-2,-1!" label = <X<SUB>3</SUB>>];
  U1 [pos = "-3,0!"  label = <U<SUB>1</SUB>>];

  # 'edge' statements
  U1 -> X1;
  U1 -> X3;
  {X3 X1} -> X2;

 # control the placement of elements on the graph 
{rank = same; X1 ; X2; X3};

}
```
:::
:::


## Structural equation model {.smaller}

`lm(richness ~ nutrients)`\
`lm(evenness ~ nutrients)`\
`lm(biomass ~ richness + evenness + nutrients)`\

```{dot}
//| fig-width: 5
//| fig-height: 2

digraph  {

  # a 'graph' statement
  graph [overlap = false, fontsize = 10, layout = dot, splines = curved,
       rankdir = LR]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
        
  nutrients; evenness, richness; biomass;

  # several 'edge' statements
    nutrients->richness [style=dashed];
    nutrients->evenness [style=dashed];
    evenness->biomass [style=dashed];
    richness->biomass [style=dashed];
    nutrients->biomass [color=red, minlen=3];
    
    {rank=min; nutrients;}
    {rank=max; biomass;}
    {rank=same; richness evenness;}
}
```


::: {.incremental}
- Exogenous variables: 
  - only have out-going paths.   
- Endogenous variables:
  - have in-going paths
  - can have out-going paths.  
  - must be predicted. 
:::





## Mediation {.smaller}

::: {.incremental}
-   Tests whether a particular variable has a mediating effect on a path.\
-   Often used to test underlying mechanisms.
-   In our example, we could ask whether the effect of nutrients on biomass is mediated through biodiversity.
-   Possibilities: complete mediation, partial mediation, no mediation.
:::

.  .  .  

::: columns
::: {.column width="50%"}
```{dot}
//| fig-width: 5
//| fig-height: 2

digraph  {

   label     = "Full mediation"
   labelloc  =  t // t: Place the graph's title on top.
   fontsize  = 20 // Make title stand out by giving a large font size

  # a 'graph' statement
  graph [overlap = false, layout = dot, splines = curved,
       rankdir = LR]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
        
  nutrients; richness; biomass;

  # several 'edge' statements
    nutrients->richness [style=solid];
    richness->biomass [style=solid];
    
    {rank=min; nutrients;}
    {rank=max; biomass;}
    {rank=same; richness;}
}
```
:::

::: {.column width="50%"}
```{dot}
//| fig-width: 5
//| fig-height: 2

digraph  {

   label     = "Partial mediation"
   labelloc  =  t // t: Place the graph's title on top.
   fontsize  = 20 // Make title stand out by giving a large font size

  # a 'graph' statement
  graph [overlap = false, layout = dot, splines = curved,
       rankdir = LR]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
        
  nutrients; richness; biomass;

  # several 'edge' statements
    nutrients->richness [style=solid];
    richness->biomass [style=solid];
    nutrients->biomass [style=solid];

    {rank=min; nutrients;}
    {rank=max; biomass;}
    {rank=same; richness;}
}
```

:::
:::




<!-- your comment x
## Regression anatomy
![](Anatomy_linear_model.jpeg){.absolute width="800"}
-->

## Motivations to use SEM:

::: {.incremental}
1) Driver-focused: Understand how drivers influence a system 
2) Response-focused: Understand and explain a particular response of a system  
3) Mediation-focused: Understand underlying causal pathways  
4) Theory-focused: compare observations of a system to available theory 
::: 

## SEM modelling philosophy

::: {.incremental}
- A SEM should be specified based on prior evidence / theory (i.e., a meta-model).
- Each path requires justification.
- Continuum between theory (hypothesis-driven) to exploratory (data-driven) modelling.
- Causal diagram to specify relationships of actual variables (using meta-model).
:::


<!-- ## Explanatory modelling with SEM

![](images/Explanatory_modelling.png){width="60%"}

::: aside
[Grace, James B., and Kathryn M. Irvine. 2020. ‚ÄúScientist‚Äôs Guide to Developing Explanatory Statistical Models Using Causal Analysis Principles.‚Äù Ecology 101 (4): e02962.]{style="font-size: 5mm; text-align: center"}
::: -->

# Questions?

## Exercise

-   Your turn!
-   What type is your SEM (response, driver, mediation, theory focused)?
-   Draw a causal diagram of the dataset you want to understand (define nodes and edges).
-   Make a table with putative causal relationships.



# SEM model fitting

## How to estimate SEMs? 

::: {.incremental}
- Structural equation modelling is a framework rather than a statistical technique.   
- Lavaan uses Maximum likelihood estimation (ML).   
- Important: only variance-covariance matrix used for global estimation of SEM.    
:::

# Global estimation in a nutshell

## Observed variables

```{r, out.width="90%", fig.align='center'}
set.seed(5)
x <- rnorm(500, sd=runif(500, 2, 50))
x2 <- 0.5 *x + rnorm(500, sd=runif(500, 2, 50))
d <- matrix(c(x,x2), 250)
colnames(d) <-   c("X1","X2", "X3", "Y")

panel_regression_line = function(x,y, ...){
  points(x,y,...)
  linear_regression = lm(y~x)
  linear_regression_line = abline(linear_regression)
}


pairs(d, pch = 19, lower.panel=panel_regression_line, upper.panel = panel_regression_line)
```

Scatter plots of observed variables and fitted lines.   


## Variance-covariance matrix estimated from data {.smaller}

```{r}
set.seed(5)
x <- rnorm(500, sd=runif(500, 2, 50))
x2 <- 0.5 *x + rnorm(500, sd=runif(500, 2, 50))
d <- matrix(c(x,x2), 250)
V <- cov(d)
colnames(V)  <- c("X1","X2", "X3", "Y")
rownames(V)  <- c("X","X2", "X3", "Y")
kable(V)
```

-   Variances on the diagonal, covariances on the off-diagonal elements

. . .

-   Variance: $VAR_{x}=\frac{\sum_{i=1}^{N}(x_{i}-\bar{x})^2}{N-1}$
    -   Variance is the degree of spread in a set of data.

. . .

-   Covariance: $COV_{x,y}=\frac{\sum_{i=1}^{N}(x_{i}-\bar{x})(y_{i}-\bar{y})}{N-1}$
    -   Covariance measures how much two variables are moving together.

## Correlation matrix estimated from data {.smaller}

```{r}
set.seed(5)
x <- rnorm(500, sd=runif(500, 2, 50))
x2 <- 0.5 *x + rnorm(500, sd=runif(500, 2, 50))
d <- matrix(c(x,x2), 250)
V <- cov(d)
colnames(V)  <- c("X1","X2", "X3", "Y")
rownames(V)  <- c("X","X2", "X3", "Y")
kable(cov2cor(V))
```

- Correlation: $COR_{x,y}=\frac{COV_{x,y}}{\sigma_x*\sigma_y}$
  + Correlation matrix is standardized variance-covariance matrix


## SEM: compare model-implied to observed covariance 


::: columns
::: {.column width="35%"}
```{dot}
//| fig-width: 4
digraph  {

  # a 'graph' statement
  graph [overlap = false, fontsize = 15, layout = dot, rankdir = LR]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  Var1 
  Var2 
  Var3
  Var4

  # 'edge' statements
  Var1 -> Var2 -> Var4;
  Var1 -> Var3 -> Var4;  
}
```
:::
::: {.column width="65%"}
```{r, out.width="90%", fig.align='center'}
set.seed(5)
x <- rnorm(500, sd=runif(500, 2, 50))
x2 <- 0.5 *x + rnorm(500, sd=runif(500, 2, 50))
d <- matrix(c(x,x2), 250)
colnames(d) <-   c("X1","X2", "X3", "Y")
pairs(d, pch = 19)
```
:::
:::

# Interpreting path coefficients

<!-- https://jslefche.github.io/sem_book/global-estimation.html -->

::: notes
- Path coefficients inferential heart of structural equation modeling.
- Understanding how to interpret path coefficients necessary for robust SEM inference.
- Important to be aware of the defaults of SEM software, such as `lavaan`.
:::

## Unspecified relationships among exogenous variables are their bivariate correlations. {.smaller}


```{dot}
//| fig-width: 6
digraph  {

  # a 'graph' statement
  graph [overlap = false, fontsize = 15, layout = dot, rankdir = LR]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X 
  Y1 
  Y2

  # 'edge' statements
  X -> Y2
  Y1 -> Y2
  X:w -> Y1:w [dir=both]
  
  {rank=same X; Y1}

}
```

## When two variables are connected by a single path, the coefficient of that path is the regression coefficient. {.smaller}

```{dot}
//| fig-width: 6
digraph  {

  # a 'graph' statement
  graph [overlap = false, fontsize = 15, layout = dot, rankdir = LR]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X 
  Y1 
  Y2
  
  # 'edge' statements
  X -> Y1 [label = <&gamma;<SUB>X,Y1</SUB>>]
  Y1 -> Y2 [label = <&beta;<SUB>Y1,Y2</SUB>>]
}
```



## The strength of a compound path is the product of the individual coefficients {.smaller} 

```{dot}
//| fig-width: 6
digraph  {

  # a 'graph' statement
  graph [overlap = false, fontsize = 15, layout = dot, rankdir = TB, splines=ortho]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X 
  Y1 
  Y2

  # 'edge' statements
  X -> Y2 [style = dashed label = <&gamma;<SUB>X,Y1</SUB> * &beta;<SUB>Y1,Y2</SUB>>, color=white]
  X  -> Y1
  Y1 -> Y2

  

{rank=same X; Y1, Y2}


}

```

## When variables are connected by more than one pathway, each pathway is the 'partial' regression coefficient {.smaller}

::: {.incremental}
-   The partial regression coefficient accounts for influence of more than one variable on the response\
-   In other words, the coefficient for one predictor controls for the influence of other predictors in the model\
-   The coefficients of multiple regression are partial coefficients
::: 

```{dot}
//| fig-width: 5
digraph {

  # a 'graph' statement
  graph [overlap = false, fontsize = 5, layout = dot, rankdir = LR];

  # 'node' statements
  node [shape = box, fontname = Helvetica];
  
  X; 
  Y1; 
  Y2;
  
  # 'edge' statements
  X -> Y2 [label = <&beta;<SUB>X,Y2</SUB>> minlen=3 ];
  Y1 -> Y2 [label = <&beta;<SUB>Y1,Y2</SUB>> minlen=3 ];

}
```


## Errors on endogenous variables relate the unexplained correlations or variances arising from unmeasured variables {.smaller}

::: {.incremental}
-   $R^{2}$: ratio of explained to total variation in response (here Y1)\
-   Unexplained or residual variance = $1 - R^{2}$
-   Captures other (unknown) sources causing correlation between Y1 and other variables to deviate from 1.
-   In a path diagram, error variances are often represented as $\zeta$ with an arrow leading into the endogenous variable.
:::

```{dot}
//| fig-width: 5
digraph {

  # a 'graph' statement
  graph [overlap = false, fontsize = 15, layout = dot, rankdir = LR];

  # 'node' statements
  node [shape = box, fontname = Helvetica];
  
  X; 
  Y1; 
  Y2;

  E3 [label = < &zeta;<SUB>Y1</SUB> = 1 - R<SUP>2</SUP>>];

    node [shape = plain,
        fontname = Helvetica];
  E1;

  # 'edge' statements
  X -> Y1;
  X -> Y2;
  E1 -> Y1; 

E1 [label = <&zeta;<SUB>Y1</SUB>>]; 

  {rank=min; X; };
{rank=max; E1; };
}
```

## Unanalyzed (residual) correlations among two endogenous variables are their partial correlations. {.smaller}

::: {.incremental}
-   If they were exogenous variables, the relationship would be their bivariate correlation.
-   Here we have we have to remove the effects of X on both variables.
-   These are known as correlated errors and represented by double-headed arrows between the errors of two endogenous variables.
:::

```{dot}
//| fig-width: 6
digraph {

  # a 'graph' statement
  graph [overlap = false, fontsize = 15, layout = dot, rankdir = LR];

  # 'node' statements
  node [shape = box, fontname = Helvetica];
  
  X; 
  Y1; 
  Y2;
  
  node [shape = plain,
        fontname = Helvetica];
        
  E1 [label = <&zeta;<SUB>Y1</SUB>>]; 
  E2 [label = <&zeta;<SUB>Y2</SUB>>]; 

  # 'edge' statements
  X -> Y1;
  X -> Y2;
  E1 -> Y1; 
  E2 -> Y2;
  E1:e -> E2:e [dir=both];

  {rank=min; X; };
  {rank=max; E1, E2};

}
```

## The total effect one variable has on another is the sum of its direct and indirect effects {.smaller}

$$ total = \gamma_{X, Y1} * \beta_{Y1, Y2} + \gamma_{X, Y2}$$

```{dot}
//| fig-width: 6
digraph {

  # a 'graph' statement
  graph [overlap = false, fontsize = 15, layout = dot, rankdir = TB, splines=ortho, ranksep = .5]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X 
  Y1 
  Y2

  # 'edge' statements

  
  X -> Y1 [label = <&gamma;<SUB>X,Y1</SUB>> minlen=3];
  Y1 -> Y2 [xlabel = <&beta;<SUB>Y1,Y2</SUB>> minlen=3];  
  X -> Y2 [xlabel = <&gamma;<SUB>X,Y2</SUB>>];

  {rank=same X; Y1, Y2};


}

```

## The total effect (including undirected paths) is equivalent to the total correlation {.smaller}


## Example: Interpreting coeffients in a simple model {.smaller}

::: columns
::: {.column width="50%"}
```{dot}
//| fig-width: 4
//| fig-height: 4

digraph {

  # a 'graph' statement
  graph [overlap = false, fontsize = 10, layout = dot, ranksep = .5,
       rankdir = RL]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  Y
  X1 [label = <X<SUB>1</SUB>>]
  X2 [label = <X<SUB>2</SUB>>]
  X3 [label = <X<SUB>3</SUB>>]
  

  # 'edge' statements
  X1 -> Y [label = "0.133"]
  X2 -> Y [label = "0.40"]
  X3 -> Y [label = "0.167"]
  
  X1:w -> X2:w [dir=both, style="dashed", label = "0.5"]
  X2:w -> X3:w [dir=both, style="dashed", label = "0.2"]
  X1:e -> X3:e [dir=both, minlen = 4, style="dashed", label = "0.4"]
  
 # control the placement of elements on the graph 
{rank = same; X1 ; X2; X3}

}
```
:::

::: {.column width="30%"}
Correlation matrix:

|  | X1 | X2 | X3 | Y |
|:---|:---|:---|:---|:---|
| X1  | 1  | .5   |  .4  | .4  |
| X2  | .5  |  1  | .2   | .5  |
| X3  | .4  |  .2  | 1   | .3  |
| Y   | .4  |  .5  | .3   | 1  |
:::
:::

.  .  .  

- Path tracing for all X-Y correlations:
  - r(X1, Y) = X1->Y + X1->X2->Y + X1->X3->Y \   
  - r(X1, Y) = .133 + (.5 * .4) + (.4 * .167) = **.4**\

.  .  .  


- likewise for corr(X2, Y) and corr(X3, Y):
  - r(X2, Y) = .4 + (.5 * .133) + (.2 * .167) = **.5** \   
  - r(X3, Y) = .167 + (.4 * .133) + (.2 * .4) = **.3**\


## Unstandardized vs standardized coefficients

| Unstandardized  | Standardized  |
|:----------------------------|:--------------------------|
| Reported in raw units | Expressed in units of standard deviations (Z transformed) |
| Essential for prediction | Used for interpretation of relative strength |
| Useful for comparing across models with same variables but different datasets | Only comparable within the same dataset/model |
| Contain information about variance and mean | Facilitate comparison of paths within a model |

> Z transformation results in mean of 0 and SD of 1: $Z = \frac{x - \mu(x)}{\sigma(x)}$

<!-- ::: aside
$r_{xy} = \frac{cov_{xy}}{SD_x \times SD_y}$
where $r_{xy}$ are the correlations, $cov_{xy}$ the covariances and $SD_x$ and $SD_y$ the respective standard deviations (the square roots of the respective variance $= \sqrt{var_x}$ and $= \sqrt{var_y}$)
:::-->


## Assumptions of SEM with lavaan

::: {.incremental}
-   (Multivariate) normality of endogenous (but not exogenous!) variables required
-   Only acyclic relationships (no loops)
-   Linear relationships
::: 

# Model evaluation

## Model fit measures {.smaller}

+ *$\chi^2$ statistic*
  - compare the model-implied to the observed variance-covariance
  - good fit when $\chi^2$ statistic is small (P > 0.05)   
  - sample-size dependent

. . .

+ *Comparative fit index (CFI)*: 
  - deviation from a 'null' model (variances estimated but covariances set to 0).
  - higher is better, \> 0.95 is considered good.

. . .

+ *Root-mean squared error of approximation (RMSEA)*
  - statistic penalizes models based on sample size
  - \< 0.10 is acceptable, and anything \< 0.06 is good

. . .

+ *Standardized root-mean squared residual (SRMR)*
  - standardized difference between the observed and predicted correlations
  - \< 0.08 is considered good

## Troubleshooting pathological models (a.k.a. Heywood cases)

-   Improper solutions:
    -   Negative variances
    -   Correlations larger than 1

. . .

-   Reasons for the warnings can be:
    1)  Slightly negative error estimates (not really a problem)\
    3)  Local non-identification of parameters\
    4)  Model misspecification

## Parameter identification

::: {.incremental}
- Identifiability is a common issue in SEM
- Some of the free parameters you are trying to estimate are interchangeable (e.g., a and b in `y = a*x + b*x + c`)
- Even an infinite amount of data does not allow to identify parameters precisely (e.g.¬†one could be high the other low or vice-versa)
- The more complex a SEM is, the more likely issues of identifiability will become
- Fixing parameters or their variance may be needed to achieve model convergence (especially when latents or composites are involved).
::: 


## Model identification

- Underidentified: 
  - Not enough pieces of information to identify parameters uniquely (df \< 0).\

. . . 

- Just identidied: 
  - Just enough information to uniquely identify parameters, but no df to check model fit (df = 0).\

.  .  .

- Over-identified: 
  - Parameters can be uniquely identified and positive dfs to test model goodness-of-fit (df \> 0).


## Model identification

"t-rule" to quickly gauge whether a model is under-, just, or overidentified:

$$ t \leq \frac{n (n + 1 )}{2} $$

*t* = number of unknowns (parameters to be estimated, i.e. variances & covariances)\
*n* = number of knowns (observed variables).

The LHS is how many pieces of information we want to know.\
RHS: information we have (number of unique cells in the observed variance-covariance matrix).


## Model identification example

$$ t \leq \frac{n (n + 1 )}{2} $$

*Unidentified:*

- a + b = 8 
- multiple possible solutions (e.g., a=7, b=1, a=6, b=2 ...)

. . .

*Just identified:*

- add equation a = 3b allows to solve the system
- Single solution a = 6 and b = 2 

. . . 

*Over-identified:*

- add equation 2a - 4 = 4b gives us more information than we need 

## Model identification example

```{dot}
//| fig-width: 6
//| fig-height: 2
digraph  {

  # a 'graph' statement
  graph [overlap = false, fontsize = 15, layout = dot, rankdir = LR]

  # 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X 
  Y1 
  Y2
  
  # 'edge' statements
  X -> Y1 [label = <&gamma;<SUB>X,Y1</SUB>> ]
  Y1 -> Y2 [label = <&beta;<SUB>Y1,Y2</SUB>> ]


}
```

Can we identify this simple mediation model?

- How many many pieces of information do we have (n) and how many do we need to estimate (t)?


. . . 

$$ 5 \leq \frac{3 (3 + 1 )}{2} $$
$$ 5 \leq 6 $$


## Variable types: continuous

::: {.incremental}
  - Exogenous variables:
    - No limitations, can be used as endo- and exogenous variables
  - Endogenous variables:
    - lavaan can only handle Gaussian error distribution; for other error distributions consider piecewiseSEM package.
:::

## Variable types: categorical
::: {.incremental}

<!-- https://personality-project.org/r/tutorials/summerschool.14/rosseel_sem_cat.pdf 

https://www.aggieerin.com/post/quick-and-dirty-categorical-lavaan/

-->

- Includes binary (yes/no, failure/success, etc.), nominal (site 1, site 2), or ordinal levels (small < medium < large) variables.
  - nominal variables currently not covered by lavaan
- Exogenous variables:
  - code binary variables as dummy variable (0/1)
  - if more than 2 levels, create multiple dummy variables
- Endogenous variables:
  - for binary and ordinal variables, use R's `ordered()` function to specify the order, or use `ordered=` argument.
  - when `ordered=` argument is used, WLSMV estimator is used by lavaan.
- Bootstrapping approach to get robust standard error estimates due to non-normal errors when dealing with categorical variables.
:::



## Data requirements

::: {.incremental}
-   Replication should be at least 5x the number of estimated coefficients (not error variances or other correlations).
-   To estimate two relationships, at least n = 10 required to fit model.
-   Ideally, replication is 5-20x the number of estimated parameters.
-   The larger the sample size, the more precise (unbiased) are the estimates.
:::

## SEM check list {.smaller}

1)  Review the relevant theory and research literature to support model specification
2)  Specify a model (e.g., using causal diagram)
3)  Determine model identification
4)  Select measurements for the variables represented in the model
5)  Collect data
6)  Conduct preliminary descriptive statistical analysis (e.g., scaling, missing data, collinearity issues, outlier detection)
7)  Fit SEM
8)  Assess model goodness-of-fit
9) Check for missing or unnecessary links
10) Interpret model coefficients
11) Present results visually

<!-- ## Basic lavaan syntax

Define model:

```r
mod.form  <-
"Y ~ X1 + X2 + x3
X3 ~ X1
````

Fit model:

```r
mod.fit <- sem(mod.form , data = dat1)
```

## Lavaan syntax {.smaller}

| Formula type | R     | Meaning                   | Example                   |
|:-------------|:------|:--------------------------|:--------------------------|
| regression   | `~`   | is regressed on           | `y ~ x`                   |
| correlation  | `~~`  | correlate errors for      | `x1 ~~ x2`                |
| intercept    | `~ 1` | estimate mean for `y`     | `y ~ 1`                   |
| labelling    | `*`   | name coefficients         | `y ~ b1*x1 + b2*x2`       |
| defining     | `:=`  | define quantity           | `Total := b1*b3 + b2`     |
| latent       | `=~`  | set reflective indicators | `LV =~ x1 + x2 + x3`      |
| composite    | `<~`  | set formative indicators  | `Comp <~ 1*x1 + x2 + x3`  |
-->

# Questions?

# Live coding session

# Your turn: working with the Seabloom dataset

## Introduction to the dataset 

![](images/CedarCreek.jpg)

- Experimental grassland study (started in 1982)
- Long-term consequences of human-driven environmental changes on grasslands:
  + Soil disturbance
  + Nitrogen deposition

## Introduction to the dataset 

::: columns
::: {.column width="50%"}
![](images/CedarCreek_map.png){width="100%"}
:::

::: {.column width="50%"}
- Study site located in Minnesota (Cedar Creek Ecosystem Science Reserve).
- Design:
  + three study fields within the reserve.
  + 35 x 55 m intact (black) and disturbed (red) plots within each field.
:::
:::


## Introduction to the dataset {.smaller}

![](images/CedarCreek_exp_design.png){.relative width="800" right=200}

- 4 x 4 m nutrient treatment plots within the intact or disturbed plots (within fields A-C). 
- Letters indicate the nutrient treatments.

## Introduction to the dataset {.smaller}

![](images/AGB_disturbance.png)

- Effect of soil disturbance and nutrient enrichment on aboveground plant biomass. 
- Colors: Control and NPK+ (all nutrients plus 9.5 g N m-2 yr-1).

## Introduction to the dataset {.smaller}


![](images/AGB_diversity.png){.relative width="700" right=200}

- Effect of soil disturbance (disking) and nutrient enrichment on:
  A) effective number of species (ENS~PIE~)
  A) richness (S, species 0.3 m‚àí2)
  A) Simpsons's evenness 

::: aside
ENS~PIE~ equivalent to $1 / \sum_{i=1}^{S} p_i^2$ where $S$ is the total number of species and $p_i$ is the proportion of the community biomass represented by species $i$.
:::

  
## Potential research questions

```{dot}
//| fig-width: 8
digraph  {

   # a 'graph' statement
  graph [overlap = false, fontsize = 10, splines = curved, rankdir = LR]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  
   environment -> biodiversity -> biomass;
   environment -> biomass;
  
}
```

1)  How has aboveground biomass changed as a function of soil disturbance and nutrient addition?
2)  How are these effects mediated by biodiversity?

::: notes
Ask students about how they would address this question.
:::

## The meta-model

```{dot}
//| fig-width: 12
//| fig-height: 5

digraph  {

   # a 'graph' statement
  graph [overlap = false, fontsize = 10, rankdir = LR, ranksep=.8]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  
   subgraph cluster_bio {
        label="Biodiversity"
        fontname = Helvetica
		    color=lightgrey;
        evenness, richness;
        }


   subgraph cluster_env {
        label="Environment"
        fontname = Helvetica
     		color=lightgrey;
        nutrients;
        disturbance;
        }

    nutrients->richness;
    nutrients->evenness;
    nutrients->biomass;
    disturbance -> biomass;

   subgraph cluster_prod {
     label="Function";
     fontname = Helvetica;
     color=lightgrey;
     biomass; 
     }

    evenness->biomass ;
    richness->biomass ;
  
}
```

::: {.incremental}
1)  Function (biomass) is directly influenced by the environment (nutrients, disturbance)
2)  Function (biomass) is directly influenced by biodiversity (richness and evenness).
3)  The environment also influences biodiversity and thus, have an indirect effect on function via biodiversity.
:::


::: notes
-   Ask students about how they would address this question.
-   Thinking about what is missing in the model, measurement errors etc.
-   Present the concept of meta-model and impications for research.
-   Include a graphical representation of the meta-model as what is missing in the model.
:::


## Exercise 1 

- Load and aggregate the Seabloom dataset (data and code provided)
- Check collinearity of the following variables:
  - nadd, disk, nadd, rich, even, ens.pie, mass.above
- Check multivariate normality of the following variables using the `mvn()` function in `library(MVN)`: 
  - rich, even, mass.above
- Fit multiple linear regression models to estimate coefficients
    -   direct effects of environmental predictors on above ground biomass (AGB)
    -   (in)direct effects of environmental predictors on richness and evenness
- What do you conclude?

## Exercise 2

```{dot}
//| fig-width: 10
//| fig-height: 4

digraph  {

   # a 'graph' statement
  graph [overlap = false, fontsize = 10, rankdir = LR, ranksep=1]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica, color="gray"]
  
        evenness, richness;
        nutrients;
        disturbance;

    nutrients->richness;
    nutrients->evenness;
    nutrients -> biomass;
    disturbance -> biomass;

   # evenness:e-> richness:e [dir=both; minlen=3] ;

    evenness->biomass ;
    richness->biomass ;
  
 { rank="same"; nutrients; disturbance}
 { rank="same"; evenness; richness}
}
```

-   Fit the above DAG to the Seabloom data:
    -   Assess model goodness of fit.
    -   Investigate the modification indices. Any paths that need adding?
    -   Check model summary.
- Do you have a valid model?

## Exercise 3 

```{dot}
//| fig-width: 10
//| fig-height: 4
digraph  {

   # a 'graph' statement
  graph [overlap = false, fontsize = 10, rankdir = LR, ranksep=1]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica, color="gray"]
  
        evenness, richness;
        nutrients;
        disturbance;

    nutrients->richness;
    nutrients->evenness;
    nutrients -> biomass;
    disturbance -> biomass;

    evenness:e-> richness:e [dir=both; minlen=3, style="dashed"] ;

    evenness->biomass ;
    richness->biomass ;
  
 { rank="same"; nutrients; disturbance}
 { rank="same"; evenness; richness}
}
```


After finding a model with good fit:

-   Model analysis:
    -   Calculate the standardized coefficients.
    -   Add derived quantities (direct and indirect effects of nutrients on biomass).

## Exercise 4 


```{dot}
//| fig-width: 10
//| fig-height: 4

digraph  {

   # a 'graph' statement
  graph [overlap = false, fontsize = 10, rankdir = LR, ranksep=1]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica, color="gray"]
  
        evenness, richness;
        nutrients;
        disturbance;

    disturbance->richness;
    disturbance->evenness;
    nutrients->richness;
    nutrients->evenness;
    nutrients->biomass;
    disturbance -> biomass;

    evenness:e-> richness:e [dir=both; minlen=3, style="dashed"] ;

    evenness->biomass ;
    richness->biomass ;
  
 { rank="same"; nutrients; disturbance}
 { rank="same"; evenness; richness}
}
```

-   Saturated model:
    -   Model comparison with simpler model used in exercise 3.
    -   Perform model pruning.
    -   Decide on most parsimonious model and summarize model.
- Which model best represents your system?
- What inferences do you draw from your SEM?

## Exercise 5 

```{dot}
//| fig-width: 10
//| fig-height: 4

digraph  {

   # a 'graph' statement
  graph [overlap = false, fontsize = 10, rankdir = LR, ranksep=1]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica, color="gray"]
  
        evenness, richness;
        nutrients;
        disturbance;

    disturbance->richness;
    disturbance->evenness;
    nutrients->richness;
    nutrients->evenness;
    disturbance -> biomass [color="red"];
    nutrients -> biomass [color="red"];

    evenness:e-> richness:e [dir=both; minlen=3; style="dashed"];

    evenness->biomass ;
    richness->biomass ;
  
 { rank="same"; nutrients; disturbance}
 { rank="same"; evenness; richness}
}
```

-   Perform mediation analysis:
    -   Is there no, partial, or full mediation of disturbance on biomass via richness and eveness?
    -   Add paths from disturbance to richness and evenness, remove the direct paths to AGB (both nutrients and disturbance).
    -   Compare model fit to simple model. 
- Which model better represents your data?
 
