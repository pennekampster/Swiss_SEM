---
title: "Introduction to structural equation modelling - advanced modelling techniques"
author: "Frank Pennekamp"
institute: 
- Department of Evolutionary Biology and Environmental Sciences
- University of Zurich
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: 
  beamer_presentation:
    slide_level: 2
    theme: metropolis
    incremental: yes
    toc: no
    latex_engine: xelatex
    highlight: espresso
beameroption: "show notes"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(DiagrammeR)
library(ggplot2)
```

<!-- ## Test -->

<!-- ::: incremental  -->

<!-- - \alert<4>{This is\only<4>{ really} important} -->
<!-- - Now this -->
<!-- - And now this -->

<!-- ::: -->



## Overview

- Interactions
- Latent variables  
- Composite variables  
- Complex survey designs   
- Temporal autocorrelation  
- Spatial autocorrelation  

<!-- <div class = "notes"> -->
<!-- Some notes to myself. -->
<!-- </div> -->

## Interaction questions (Moderation)

\centering

![](images/Interaction.pdf){width=50%}

- In nature, things often are contingent on each other.
- For instance, the effect of nutrients on plant growth, may depend on how disturbed the environment is.  
- Such a behaviour is called an interaction, which indicates that the effect of the two main effects are different when combined.  
- Both positive and negative interactions are possible.  
- In regression, the interaction is represented by a coefficient that estimates the effect of the product of the two predictors.  

```{r, out.width="50%", fig.align='center', include=F}
grViz("
digraph boxes_and_circles {

  # a 'graph' statement
  graph [overlap = true, fontsize = 10, layout = dot,
       rankdir = RL]

  # several 'node' statements
  node [shape = box,
        fontname = Helvetica]
  X1; X2; Y, middleman

  # several 'edge' statements
    X1->middleman[arrowhead=none];
    middleman->Y;
    middleman[shape=none width=0 height=0 label='' style=invis]
    X2->middleman [constraint=false];

}
")
```

## Interactions (Moderation)

Interactions can be modelled in different ways in lavaan:

1) Multiple groups
2) Composites

## Interactions (Moderation)

- We will first use multigroup fitting.  
- This allows coefficients to vary among groups.  
- Lavaan offers the “group” argument to specify for which groups coefficients should be estimated.   
- Importantly, groups have to be of categorical nature. 

```mod <- sem(model, group = "age_class", data = dd)```

## Interactions (Moderation)

Lavaan allows to introduce equality constraints on various aspects via the `group.equal` argument:

```mod <- sem(model, group = "age_class", group.equal = c("regressions"), data = dd)```

Additional constraints could be:

```
group.equal=c(
"intercepts",
"means",
"regressions",
"residuals",
"residual.covariances")
```

## Interactions (Moderation)

- Even more control by having the same name for different parameters: 

```
model <- ' 
y ~ c("b1", "b1") * x1 + c("b2", "b2") * x3
x2 ~ c("b3", "b4") * x1
x3 ~ c("b5", "b5") * x2
'
```

Same coefficients for all but the effect of x1 on x2.

## Revisiting the meta-model

\centering
![](images/Metamodel.pdf){width=50%}

- A meta-model summarizes the concept behind a model and links it to theory. 
- However, some of the parts of the model may be difficult to quantify and measure directly.  
- This is because they represent an abstract, multifaceted concept (e.g., intelligence).
- Or, because we measure variables with error.
- This is where latent and composite variables are needed.   

## Latent variables

\centering
![](images/LatentCompositeSEM.pdf){width=50%}

- Latent variables are variables that are unobserved, but whose influence can be summarized through one or more indicator variables.  
- They can capture complex or conceptual properties of a system that are difficult to quantify or measure directly. 
- Latent variables are often represented by an oval node shapes (ellipses).   

```{r, out.width="50%", fig.align='center', include=F}
grViz("
digraph boxes_and_circles {
   
   node [shape=box]
   X1;X2;X3;Z;

   
   node [shape=circle]
   Y
    
    Y -> X1;
    Y -> X2;
    Y -> X3;
    Y -> Z;
    Z;
    
  X1->X2->X3 [style='invis']
  {rank = 'max'; Z}
  {rank = 'min'; X1}
  {rank = 'same'; X1;X2;X3}
}
")
```

## Latent variables

\centering
![](images/LatentCompositeSEM.pdf){width=50%}

- First, the direction of causality is reversed from what you might expect: from the latent variables to the observed variable (reflective indicators). 
- This is because the indicator variable is an emergent manifestation of the underlying phenomenon represented by the latent variable.   
- All indicator variables should be positively correlated to the latent variable, since they are driven by it. Recode to achieve this. 
- A latent variable is free of random or systematic measurement errors in contrast to its indicators

## Composite variables

\centering
![](images/LatentCompositeSEM.pdf){width=50%}

- Composite variables specify the influences of collections of other variables (examples).
- In comparison to latent variables, they arise from the indicators.  
- they are visualized by arrows pointing from the indicators to the composite (formative or causal indicators).
- since its values are determined by its causes (indicators), the error variance is specified to be 0.  
- Composites are often shown as hexangular shapes or ellipses (latent composites).  

```{r, out.width="50%", fig.align='center', include=F}
grViz("
digraph boxes_and_circles {
   
   node [shape=box]
   X1;X2;X3;Z;

   
   node [shape=hexagon]
   Y
    
      X1 -> Y;
    X2 -> Y;
    X3 -> Y;
    Y -> Z;
    Z;
    
  X1->X2->X3 [style='invis']
  {rank = 'max'; Z}
  {rank = 'same'; X1;X2;X3}
}
")
```

## Key differences between latent and composite variables

- flow of causation in a latent variables is from the construct to its indicators, i.e., indicators are driven by an underlying, unmeasured process represented by the latent variable.   
- for composite variables, the flow of causation is reversed and the indicators are independent entities no matter the construct.   
- If the indicators are redundant, they likely belong to a latent variable.   
- If the meaning of the construct changes after dropping one of the indicators, the construct likely is a composite.  
- As a latent variable represents an underlying, data-generating process, its indicators need to be correlated to each other. 
- In the case of a composite variable, there is no assumption about the relation between the indicators. Thus, correlation among indicators are uninformative about the direction of the causal flow, but a lack of such contraindicates that the construct is a latent variable.

## Complex sampling structure

- Often, the data is nested within sites or contains groups with non-random differences such as sexes or lifestages.  
- As  such, data violates the principle of being i.i.d. (independent and identically distributed).  
- Necessary to account for this structure in the data in the model.
- The add-on package lavaan.survey allows the analysis of stratified, clustered or weighted data.  
- lavaan objects can be processed further with a specific data structure:
  1) initialize the design   
  2) post-process the lavaan object and compute the adjusted results.
  3) Result is a corrected lavaan object.

## Spatial autocorrelation

## Questions?

